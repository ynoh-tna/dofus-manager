from .config import *
from .utils import make_executable


def generate_rename_script(class_list, workspace=None):
    """Generate the rename_windows.sh script - exact copy of working script."""
    classes_str = ' '.join([f"'{c}'" for c in class_list])

    bash_script = """#!/bin/bash
CLASS_LOGIN=(""" + classes_str + """)
WIN_EXCLUS="Dofus-""" + class_list[0] + """"

# Find all Dofus windows in any workspace
WINDOWS=($(wmctrl -l | awk '/ Dofus($|-)/ {print $1}'))

if [[ ${#WINDOWS[@]} -eq 0 ]]; then
    echo "No windows in the current workspace ($CURRENT_WS)."
    exit 0
fi

echo "Windows on workspace $CURRENT_WS : ${#WINDOWS[@]}"

# rename windows with CLASS_LOGIN
COUNT=0
for WIN_ID in "${WINDOWS[@]}"; do
    CLASS_NAME="${CLASS_LOGIN[$COUNT]}"
    if [[ -n "$CLASS_NAME" ]]; then
        wmctrl -ir "$WIN_ID" -N "Dofus-$CLASS_NAME"
        echo "Windows renamed : Dofus-$CLASS_NAME"
    else
        echo "Not enough name in CLASS_LOGIN to rename all windows."
        break
    fi
    COUNT=$((COUNT+1))
done

echo "Rename ended."

# Mute all Dofus windows unless WIN_EXCLUS
wmctrl -l | grep "Dofus-" | grep -v "$WIN_EXCLUS" | while read -r LINE; do
    WIN_ID=$(echo "$LINE" | awk '{print $1}')
    PID=$(xprop -id "$WIN_ID" _NET_WM_PID | awk '{print $3}')
    
    if [[ -n "$PID" ]]; then
        # For each sink-input matching the PID --> mute
        pactl list sink-inputs | \\
        awk "/Sink Input/ {entry=\\$0} /application.process.id = \\"$PID\\"/ {print entry}" | \\
        grep "Sink Input" | while read -r ENTRY; do
            INPUT_ID=$(echo "$ENTRY" | grep -oE '[0-9]+')
            pactl set-sink-input-mute "$INPUT_ID" 1
            echo "Windows muted : $WIN_ID (PID $PID, Sink $INPUT_ID)"
        done
    fi
done

echo "Muting ended."
"""

    RENAME_SCRIPT.write_text(bash_script)
    make_executable(RENAME_SCRIPT)


def generate_reorganize_script(class_list):
    """Generate script to reorganize windows in taskbar by moving through workspaces."""
    classes_str = ' '.join([f"'{c}'" for c in class_list])
    
    bash_script = """#!/bin/bash
# Auto-generated by Dofus Window Manager
# Reorder windows by moving them to another workspace then back

CLASS_ORDER=(""" + classes_str + """)

echo "Scanning for Dofus windows..."

declare -A window_ids
declare -A window_workspaces

while IFS= read -r line; do
    WIN_ID=$(echo "$line" | awk '{print $1}')
    WS=$(echo "$line" | awk '{print $2}')
    TITLE=$(echo "$line" | awk '{print $NF}')
    
    if [[ "$TITLE" =~ Dofus-([A-Za-z]+) ]]; then
        CLASS="${BASH_REMATCH[1]}"
        window_ids["$CLASS"]="$WIN_ID"
        window_workspaces["$CLASS"]="$WS"
        echo "Found: $CLASS in workspace $WS"
    fi
done < <(wmctrl -l)

if [[ ${#window_ids[@]} -eq 0 ]]; then
    echo "No Dofus windows found"
    exit 1
fi

# Get the current workspace of first window
CURRENT_WS="${window_workspaces["${CLASS_ORDER[0]}"]}"
echo "Current workspace: $CURRENT_WS"

# Find a different workspace to use temporarily
OTHER_WS=0
if [[ $CURRENT_WS -eq 0 ]]; then
    OTHER_WS=1
else
    OTHER_WS=0
fi

echo "Using workspace $OTHER_WS as temporary"

echo "Moving all windows to temporary workspace..."
for class in "${!window_ids[@]}"; do
    WIN_ID="${window_ids["$class"]}"
    wmctrl -ir "$WIN_ID" -b "remove,sticky" 2>/dev/null
    wmctrl -ir "$WIN_ID" -t "$OTHER_WS" 2>/dev/null
    sleep 0.1
done

sleep 0.5

echo "Moving windows back in correct order..."

for idx in "${!CLASS_ORDER[@]}"; do
    CLASS="${CLASS_ORDER[$idx]}"
    WIN_ID="${window_ids["$CLASS"]}"
    
    if [[ -n "$WIN_ID" ]]; then
        echo "Moving $CLASS back to workspace $CURRENT_WS"
        wmctrl -ir "$WIN_ID" -t "$CURRENT_WS" 2>/dev/null
        sleep 0.2
    fi
done

echo "Done - windows reordered in taskbar"
"""
    
    REORGANIZE_SCRIPT.write_text(bash_script)
    make_executable(REORGANIZE_SCRIPT)


def generate_cycle_forward(class_list):
    """Generate cycle forward script"""
    classes_str = ' '.join([f"'{c}'" for c in class_list])
    script = f"""#!/bin/bash
# Auto-generated by Dofus Window Manager

CLASS_INI=({classes_str})
STATE_FILE="/tmp/dofus_window_index"

AVAILABLE=($(wmctrl -l | grep "Dofus-" | awk '{{print $4}}' | cut -d'-' -f2))

if [[ ${{#AVAILABLE[@]}} -eq 0 ]]; then
    echo "No window detected."
    exit 1
fi

if [ -f "$STATE_FILE" ]; then
    INDEX=$(cat "$STATE_FILE")
else
    INDEX=0
fi

TOTAL=${{#CLASS_INI[@]}}
for ((i=1; i<=TOTAL; i++)); do
    NEXT=$(( (INDEX + i) % TOTAL ))
    CLASS_NAME=${{CLASS_INI[$NEXT]}}
    if printf '%s\\n' "${{AVAILABLE[@]}}" | grep -q "^$CLASS_NAME$"; then
        wmctrl -a "Dofus-$CLASS_NAME"
        echo "$NEXT" > "$STATE_FILE"
        echo "Switch to Dofus-$CLASS_NAME"
        exit 0
    fi
done

echo "No windows has been found."
"""
    CYCLE_FORWARD.write_text(script)
    make_executable(CYCLE_FORWARD)


def generate_cycle_backward(class_list):
    """Generate cycle backward script"""
    classes_str = ' '.join([f"'{c}'" for c in class_list])
    script = f"""#!/bin/bash
# Auto-generated by Dofus Window Manager

CLASS_INI=({classes_str})
STATE_FILE="/tmp/dofus_window_index"

AVAILABLE=($(wmctrl -l | grep "Dofus-" | awk '{{print $4}}' | cut -d'-' -f2))

if [[ ${{#AVAILABLE[@]}} -eq 0 ]]; then
    echo "No window detected."
    exit 1
fi

if [ -f "$STATE_FILE" ]; then
    INDEX=$(cat "$STATE_FILE")
else
    INDEX=0
fi

TOTAL=${{#CLASS_INI[@]}}
for ((i=1; i<=TOTAL; i++)); do
    NEXT=$(( (INDEX - i + TOTAL) % TOTAL ))
    CLASS_NAME=${{CLASS_INI[$NEXT]}}
    if printf '%s\\n' "${{AVAILABLE[@]}}" | grep -q "^$CLASS_NAME$"; then
        wmctrl -a "Dofus-$CLASS_NAME"
        echo "$NEXT" > "$STATE_FILE"
        echo "Switch to Dofus-$CLASS_NAME"
        exit 0
    fi
done

echo "No windows has been found."
"""
    CYCLE_BACKWARD.write_text(script)
    make_executable(CYCLE_BACKWARD)


def generate_toggle_workspace():
    """Generate toggle workspace script"""
    script = """#!/bin/bash
# Auto-generated by Dofus Window Manager

CURRENT_WS=$(wmctrl -d | awk '$2 == "*" {print $1}')

if [ "$CURRENT_WS" -eq 0 ]; then
    wmctrl -s 1
else
    wmctrl -s 0
fi
"""
    TOGGLE_WORKSPACE.write_text(script)
    make_executable(TOGGLE_WORKSPACE)


def generate_space_cycle_forward():
    """Generate space + cycle forward script"""
    script = f"""#!/bin/bash
# Auto-generated by Dofus Window Manager
# Press spacebar then cycle forward

xdotool key space

"{CYCLE_FORWARD}"
"""
    SPACE_CYCLE_FORWARD.write_text(script)
    make_executable(SPACE_CYCLE_FORWARD)


def generate_click_cycle():
    """Generate a script that simulates a left click and cycles windows"""
    script = f"""#!/bin/bash
# Auto-generated by Dofus Window Manager

xdotool click 1

"{CYCLE_FORWARD}"
"""
    CLICK_CYCLE_FORWARD.write_text(script)
    make_executable(CLICK_CYCLE_FORWARD)